syntax = "proto3";
package manycastr;

// The controller which controls and is responsible for most communication
service Controller {
  // Worker lets the orchestrator know the measurement is finished
  rpc MeasurementFinished(Finished) returns (Ack) {}
  // Worker announces itself, and starts its connection with the orchestrator. The orchestrator sends a stream of tasks
  rpc WorkerConnect(Worker) returns (stream Task) {}
  // CLI instructs orchestrator to perform a measurement
  rpc DoMeasurement(ScheduleMeasurement) returns (stream TaskResult) {}
  // CLI asks orchestrator its current status (list of connected workers and measurements)
  rpc ListWorkers(Empty) returns (Status) {}
  // Worker sends TaskResult to orchestrator
  rpc SendResult(TaskResult) returns (Ack) {}
}

// Empty message
message Empty {}

// Acknowledgement of a measurement with a boolean whether it was successful or not and a possible error message.
message Ack {
  bool is_success = 1;
  string error_message = 2;
}

// Finished message, sent by a worker to the orchestrator when a measurement is finished, or as acknowledgement of a received task result
message Finished {
  uint32 m_id = 1;
  uint32 worker_id = 2;
}

// Schedule a measurement with the orchestrator
message ScheduleMeasurement {
  uint32 probing_rate = 1;
  repeated Configuration configurations = 2; // Configuration of worker and origin combinations
  uint32 m_type = 3;
  bool is_unicast = 4;
  bool is_ipv6 = 5;
  uint32 worker_interval = 6;
  bool is_responsive = 7;
  bool is_latency = 8;
  bool is_divide = 9;
  Targets targets = 10;
  string record = 11; // Record to send CHAOS (TXT) or A/AAAA requests for
  string url = 12; // URL to encode in probes (e.g., opt-out link)
  uint32 probe_interval = 13; // interval between probes from/to the same origin,dst pair
  uint32 number_of_probes = 14; // number of probes to send per origin,dst pair
}

// A list of workers
message Status {
  repeated Worker workers = 1;
}

// Worker definition, contains a worker ID, metadata (hostname), status
message Worker {
  fixed32 worker_id = 1;
  string hostname = 2;
  string status = 3; // IDLE, PROBING, LISTENING, DISCONNECTED
  Address unicast_v6 = 4;
  Address unicast_v4 = 5;
}

// Address message, can be either an IPv4 or IPv6 address
message Address {
  oneof value {
    fixed32 v4 = 1;
    IPv6 v6 = 2;
  }
}

// IPv6 address message (protobuf does not support 128 bit values)
message IPv6 {
  fixed64 p1 = 1;
  fixed64 p2 = 2;
}

// A task for a worker, either a start or end message, a list of targets, or a traceroute task
message Task {
  oneof data {
    End end = 1; // End measurement
    Start start = 2; // Start measurement
    Targets targets = 3; // Targets to measure
    TraceTask trace_task = 5; // Traceroute task
  }
  optional uint32 worker_id = 4; // Unique worker ID for the client
}

// A start message, forwards the configuration to the worker
message Start {
  uint32 rate = 1;
  uint32 m_id = 2;
  uint32 m_type = 3;
  repeated Origin tx_origins = 4; // origins to send with
  bool is_unicast = 5;
  bool is_ipv6 = 6;
  repeated Origin rx_origins = 7; // origins to listen for
  string record = 8; // domain to use for DNS queries (TXT/A/AAAA)
  string url = 9; // URL encoded in probes
  bool is_latency = 10; // whether the measurement is for latency
}

// Notify the worker to start listening for traceroute replies (ICMP Time Exceeded)
message TraceStart {
  uint32 trace_id = 1; // ID to encode in traceroute probes
  repeated Address trace_origins = 2; // Source addresses on which to expect traceroute replies
  string url = 3; // Optional opt-out URL to encode at the end of traceroute probes' payload
}

// An end message, indicates the worker should stop sending out probes (also used for TraceTask)
message End {
  uint32 code = 1; // 0 -> finished, 1 -> CLI disconnect
}

// Origin: the source address and port combinations used by workers in a measurement, alongside an identifier
message Origin {
  Address src = 1;
  fixed32 sport = 2;
  fixed32 dport = 3;
  fixed32 origin_id = 4;
}

// Configuration: mapping of worker ID to origin
message Configuration {
  Origin origin = 1;
  uint32 worker_id = 2;
}

// A list of target addresses
message Targets {
  repeated Address dst_list = 1;
  optional bool is_discovery = 2; // whether the targets are being probed as discovery (responsiveness, latency)
}

// A traceroute task, containing a destination addres, the TTL value to use, the protocol type, and the origin to use
message TraceTask {
  Address dst = 1; // target address of the traceroute probe
  uint32 ttl = 2; // TTL to use for the traceroute probe
  Origin origin = 3; // origin to use for the traceroute probe
  bool is_unicast = 4; // whether to use the unicast address
}

// A TaskResult, contains the worker that executed the task, and a list of results
message TaskResult {
  uint32 worker_id = 1;
  // TODO allow for either Reply and TraceReply in the same message
  repeated Reply result_list = 2;
  bool is_discovery = 3; // whether the reply is part of a discovery measurement
  repeated TraceReply trace_result_list = 4;
}

// Probe reply message
message Reply {
  Address src = 1;
  fixed32 ttl = 2;
  uint64 rx_time = 3;
  uint64 tx_time = 4;
  fixed32 tx_id = 5;
  fixed32 origin_id = 6; // ID of the destination origin (ip, ports) of the reply
  optional string chaos = 7;
}

// Traceroute probe reply
message TraceReply {
  Address hop_addr = 1; // source address of the traceroute probe reply
  Address dst = 2; // target address (i.e., destination of the traceroute probe)
  uint32 hop_count = 3; // number of hops (TTL) of the traceroute probe that resulted in this reply
  uint32 ttl = 4; // TTL of the traceroute reply
  uint64 rx_time = 5; // receive time of the traceroute probe reply
  uint64 tx_time = 6; // transmit time of the traceroute probe
  uint32 tx_worker_id = 7; // worker ID of the worker that sent out the traceroute probe that resulted in this reply
  fixed32 origin_id = 8; // ID of the destination origin (ip, ports) of the reply
}
